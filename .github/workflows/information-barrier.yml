name: Information Barrier & Secret Detection

# Purpose: Comprehensive security scanning to prevent accidental leaks of trade secrets
# Runs on every push and pull request to detect:
# - API keys, tokens, credentials
# - Code files in spec-only repository
# - Prompt engineering patterns
# - Customer data patterns
# - Model weights and binaries
# - Private infrastructure references

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  secret-scanning:
    name: Secret & Sensitive Data Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ============================================================================
      # TRUFFELHOG - Industry-standard secret detection (FIXED)
      # ============================================================================
      - name: Install TruffleHog
        run: |
          echo "ğŸ“¦ Installing TruffleHog..."
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
          echo "Installed version:"
          trufflehog --version
          echo ""

      - name: Run TruffleHog secret scan
        run: |
          echo "ğŸ” Running TruffleHog secret detection..."
          echo ""

          # Create exclusions list for documentation that contains example patterns
          EXCLUDE_PATHS=(
            ".git/"
            ".github/workflows/information-barrier.yml"
            "legal/LICENSE"
            "legal/TRADEMARKS.md"
            "docs/INFORMATION_CLASSIFICATION_GUIDE.md"
            "docs/PRIVATE_REPOSITORY_GUIDE.md"
            ".github/SECURITY.md"
            ".github/CONTRIBUTING_SECURITY.md"
            ".github/ISSUE_TEMPLATE/"
          )

          # Build exclude flags
          EXCLUDE_FLAGS=""
          for path in "${EXCLUDE_PATHS[@]}"; do
            EXCLUDE_FLAGS="$EXCLUDE_FLAGS --exclude-paths=$path"
          done

          # Run TruffleHog scan
          set +e  # Don't exit on error, we'll handle it
          trufflehog filesystem . \
            $EXCLUDE_FLAGS \
            --json \
            --no-update \
            --concurrency=4 \
            > trufflehog-report.json 2>&1
          EXIT_CODE=$?
          set -e

          # Check if any secrets were found
          if [ -f trufflehog-report.json ] && [ -s trufflehog-report.json ]; then
            # Check if file contains actual findings (not just empty or errors)
            FINDING_COUNT=$(cat trufflehog-report.json | jq -s 'length' 2>/dev/null || echo "0")

            if [ "$FINDING_COUNT" != "0" ] && [ "$FINDING_COUNT" != "null" ]; then
              echo "::error::âŒ TruffleHog detected $FINDING_COUNT potential secret(s)!"
              echo ""
              echo "ğŸ“‹ Secret Detection Report:"
              echo "============================"

              # Display findings (limit to first 10)
              cat trufflehog-report.json | jq -r '
                limit(10; .[]) |
                "ğŸš¨ Detector: \(.DetectorName // "Unknown")\n" +
                "   File: \(.SourceMetadata.Data.Filesystem.file // "unknown")\n" +
                "   Line: \(.SourceMetadata.Data.Filesystem.line // "N/A")\n" +
                "   Verified: \(.Verified // false)\n"
              ' 2>/dev/null || {
                echo "âš ï¸  Unable to parse JSON, showing raw output (first 50 lines):"
                head -n 50 trufflehog-report.json
              }

              if [ "$FINDING_COUNT" -gt 10 ]; then
                echo "... and $(($FINDING_COUNT - 10)) more findings (see artifact)"
              fi

              echo ""
              echo "ğŸ’¡ Next Steps:"
              echo "   1. Review the findings above carefully"
              echo "   2. Remove any actual secrets from code/commits"
              echo "   3. If false positives, add to exclude list"
              echo "   4. Download full report from workflow artifacts"

              exit 1
            fi
          fi

          echo "âœ… TruffleHog: No secrets detected"
          echo ""

      # ============================================================================
      # GITLEAKS - Comprehensive secret scanning (FIXED)
      # ============================================================================
      - name: Install GitLeaks
        run: |
          echo "ğŸ“¦ Installing GitLeaks..."
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          echo "Installed version:"
          gitleaks version
          echo ""

      - name: Create GitLeaks config
        run: |
          cat > .gitleaks.toml <<'EOF'
          # GitLeaks Configuration for YARA LÃ³gica
          title = "YARA LÃ³gica Secret Detection"

          [allowlist]
            description = "Allowlist for documentation and example patterns"

            # Paths to exclude (documentation with examples)
            paths = [
              '''\.github/workflows/information-barrier\.yml''',
              '''\.github/SECURITY\.md''',
              '''\.github/CONTRIBUTING_SECURITY\.md''',
              '''\.github/ISSUE_TEMPLATE/''',
              '''legal/LICENSE''',
              '''legal/TRADEMARKS\.md''',
              '''docs/INFORMATION_CLASSIFICATION_GUIDE\.md''',
              '''docs/PRIVATE_REPOSITORY_GUIDE\.md'''
            ]

            # Regex patterns that are examples/documentation (not real secrets)
            regexes = [
              '''(api_key|apikey|api-key).*(example|placeholder|test|demo|sample)''',
              '''(password|passwd).*(example|placeholder|test|demo|sample)''',
              '''AKIA[0-9A-Z]{16}.*[Ee]xample''',
              '''sk-[a-zA-Z0-9]{32}.*[Ee]xample''',
              '''# Example''',
              '''# Sample''',
              '''<your-.*>''',
              '''YOUR_.*_HERE'''
            ]

            # Specific strings that are documentation
            stopwords = [
              '''example''',
              '''placeholder''',
              '''sample''',
              '''demo''',
              '''test'''
            ]
          EOF

          echo "âœ… GitLeaks config created"

      - name: Run GitLeaks scan
        run: |
          echo "ğŸ” Running GitLeaks secret detection..."
          echo ""

          set +e
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            --report-path gitleaks-report.json \
            --exit-code 1 \
            --verbose 2>&1 | tee gitleaks-output.log
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -ne 0 ]; then
            echo ""
            echo "::error::âŒ GitLeaks detected secrets!"

            if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ]; then
              FINDING_COUNT=$(cat gitleaks-report.json | jq 'length' 2>/dev/null || echo "unknown")
              echo ""
              echo "ğŸ“‹ Found $FINDING_COUNT potential secret(s)"
              echo "========================================"

              # Display findings
              cat gitleaks-report.json | jq -r '
                .[] |
                "ğŸš¨ Rule: \(.RuleID // .Description)\n" +
                "   File: \(.File)\n" +
                "   Line: \(.StartLine)\n" +
                "   Match: \(.Match // .Secret | .[0:50])...\n"
              ' 2>/dev/null || {
                echo "âš ï¸  Unable to parse JSON, showing raw output:"
                cat gitleaks-report.json
              }
            else
              echo "âš ï¸  No detailed report available, check output log"
              if [ -f gitleaks-output.log ]; then
                tail -n 30 gitleaks-output.log
              fi
            fi

            echo ""
            echo "ğŸ’¡ To fix:"
            echo "   1. Review findings above"
            echo "   2. Remove actual secrets"
            echo "   3. For false positives, update .gitleaks.toml allowlist"

            exit 1
          fi

          echo "âœ… GitLeaks: No secrets detected"
          echo ""

      # ============================================================================
      # CUSTOM DLP SCANNER - Alter Agro specific patterns
      # ============================================================================
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip --quiet

      - name: Run custom DLP scanner
        run: |
          echo "ğŸ” Running custom DLP scanner for Alter Agro patterns..."
          echo ""

          if [ ! -f "infra/github/scan_secrets.py" ]; then
            echo "::warning::Custom DLP scanner not found (infra/github/scan_secrets.py)"
            echo "Skipping custom DLP check"
            exit 0
          fi

          set +e
          python infra/github/scan_secrets.py \
            --strict \
            --output dlp-report.json 2>&1
          EXIT_CODE=$?
          set -e

          if [ "$EXIT_CODE" -ne 0 ]; then
            echo ""
            echo "::error::âŒ Custom DLP scanner detected violations!"

            if [ -f dlp-report.json ] && [ -s dlp-report.json ]; then
              echo ""
              echo "ğŸ“‹ DLP Violations:"
              echo "=================="

              cat dlp-report.json | jq -r '
                .violations[]? |
                "âš ï¸  \(.severity | ascii_upcase): \(.description)\n" +
                "   File: \(.file_path):\(.line_number)\n" +
                "   Category: \(.category)\n" +
                "   Pattern: \(.pattern)\n"
              ' 2>/dev/null || {
                echo "Unable to parse JSON, showing raw:"
                head -n 50 dlp-report.json
              }
            fi

            echo ""
            echo "ğŸ’¡ Action required:"
            echo "   1. Review DLP violations above"
            echo "   2. Remove sensitive patterns"
            echo "   3. Ensure compliance with P0-Public classification"

            exit 1
          fi

          echo "âœ… Custom DLP: No violations detected"
          echo ""

      # ============================================================================
      # FORBIDDEN TERMS DETECTION
      # ============================================================================
      - name: Scan for forbidden terms
        run: |
          echo "ğŸ” Scanning for forbidden terms..."
          echo ""

          # Forbidden patterns (case-insensitive)
          # Excluding documentation files that explain these terms
          PATTERNS=(
            'api_key[[:space:]]*[:=][[:space:]]*["\047][a-zA-Z0-9_-]{16,}'
            'api-key[[:space:]]*[:=][[:space:]]*["\047][a-zA-Z0-9_-]{16,}'
            'apikey[[:space:]]*[:=][[:space:]]*["\047][a-zA-Z0-9_-]{16,}'
            'secret[_-]?key[[:space:]]*[:=][[:space:]]*["\047][a-zA-Z0-9_-]{16,}'
            'password[[:space:]]*[:=][[:space:]]*["\047][a-zA-Z0-9_-]{8,}'
            'passwd[[:space:]]*[:=][[:space:]]*["\047][a-zA-Z0-9_-]{8,}'
            'bearer[[:space:]]+[a-zA-Z0-9_\.-]{20,}'
            'AKIA[0-9A-Z]{16}[^Ee]'
            '-----BEGIN.*PRIVATE KEY-----'
          )

          EXCLUDE_FILES=(
            ".github/workflows/information-barrier.yml"
            ".github/SECURITY.md"
            ".github/CONTRIBUTING_SECURITY.md"
            "docs/INFORMATION_CLASSIFICATION_GUIDE.md"
            "docs/PRIVATE_REPOSITORY_GUIDE.md"
            "legal/"
          )

          # Build exclusion pattern
          EXCLUDE_PATTERN=""
          for exclude in "${EXCLUDE_FILES[@]}"; do
            EXCLUDE_PATTERN="$EXCLUDE_PATTERN --exclude=$exclude"
          done

          VIOLATIONS=0
          for pattern in "${PATTERNS[@]}"; do
            echo "Checking pattern: ${pattern:0:40}..."

            if git grep -i -n -E "$pattern" -- . $EXCLUDE_PATTERN 2>/dev/null; then
              echo "::error::Forbidden term detected: $pattern"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done

          echo ""
          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Found $VIOLATIONS forbidden term violation(s)"
            echo ""
            echo "ğŸ’¡ These patterns suggest actual secrets in code."
            echo "   Remove them immediately and rotate any exposed credentials."
            exit 1
          fi

          echo "âœ… No forbidden terms detected"
          echo ""

      # ============================================================================
      # CODE FILE DETECTION (outside allowed directories)
      # ============================================================================
      - name: Block unauthorized code files
        run: |
          echo "ğŸ” Checking for code files outside infra/github/..."
          echo ""

          # Code file extensions that should ONLY exist in infra/github/ or .github/
          CODE_EXTS=('\.py$' '\.js$' '\.ts$' '\.tsx$' '\.jsx$' '\.go$' '\.java$' '\.rb$' '\.php$' '\.rs$')

          VIOLATIONS=0
          for ext in "${CODE_EXTS[@]}"; do
            # Find code files outside infra/github/ and .github/
            if git ls-files | grep -E "$ext" | grep -v '^infra/github/' | grep -v '^\.github/' | grep -v '^lsa/spec/examples/' > /tmp/bad-code-files.txt 2>/dev/null; then
              if [ -s /tmp/bad-code-files.txt ]; then
                echo "::error::Code files ($ext) found outside allowed directories:"
                cat /tmp/bad-code-files.txt
                echo ""
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done

          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Unauthorized code files detected!"
            echo ""
            echo "ğŸ’¡ This is a spec-only repository."
            echo "   Runtime code belongs in private repositories."
            echo "   Allowed locations: infra/github/, .github/, lsa/spec/examples/"
            exit 1
          fi

          echo "âœ… No unauthorized code files detected"
          echo ""

      # ============================================================================
      # PROMPT ENGINEERING PATTERN DETECTION
      # ============================================================================
      - name: Detect prompt engineering patterns
        run: |
          echo "ğŸ” Scanning for prompt engineering patterns..."
          echo ""

          PROMPT_PATTERNS=(
            'system:[[:space:]]*["\047]'
            'user:[[:space:]]*["\047]'
            'assistant:[[:space:]]*["\047]'
            '<\|im_start\|>'
            '<\|im_end\|>'
            '<<SYS>>'
            '<</SYS>>'
            'You are a helpful assistant'
            'Answer the following question'
          )

          EXCLUDE_FILES=(
            ".github/workflows/information-barrier.yml"
            "docs/"
            "README.md"
          )

          EXCLUDE_PATTERN=""
          for exclude in "${EXCLUDE_FILES[@]}"; do
            EXCLUDE_PATTERN="$EXCLUDE_PATTERN --exclude=$exclude"
          done

          WARNINGS=0
          for pattern in "${PROMPT_PATTERNS[@]}"; do
            if git grep -i -n "$pattern" -- . $EXCLUDE_PATTERN 2>/dev/null; then
              echo "::warning::Potential prompt pattern detected: $pattern"
              WARNINGS=$((WARNINGS + 1))
            fi
          done

          if [ $WARNINGS -gt 0 ]; then
            echo ""
            echo "âš ï¸  Found $WARNINGS potential prompt pattern(s)"
            echo "   Verify these are not production prompt templates (P3-Trade Secret)"
          fi

          echo "âœ… Prompt pattern scan complete"
          echo ""

      # ============================================================================
      # MODEL WEIGHTS AND BINARY DETECTION
      # ============================================================================
      - name: Block model weights and large binaries
        run: |
          echo "ğŸ” Checking for model weights and binaries..."
          echo ""

          # Binary/model file extensions (strictly prohibited)
          BINARY_EXTS=('\.bin$' '\.safetensors$' '\.ckpt$' '\.pth$' '\.pkl$' '\.h5$' '\.pb$' '\.onnx$')

          VIOLATIONS=0
          for ext in "${BINARY_EXTS[@]}"; do
            if git ls-files | grep -E "$ext" > /tmp/binary-files.txt 2>/dev/null; then
              if [ -s /tmp/binary-files.txt ]; then
                echo "::error::Model/binary files detected ($ext):"
                cat /tmp/binary-files.txt
                echo ""
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done

          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Model weights or binaries detected!"
            echo ""
            echo "ğŸ’¡ Model files are P3-Trade Secrets."
            echo "   They must NOT be in the public repository."
            echo "   Store them in private runtime repositories or model registries."
            exit 1
          fi

          echo "âœ… No model weights or binaries detected"
          echo ""

      # ============================================================================
      # FILE SIZE LIMITS
      # ============================================================================
      - name: Check file size limits
        run: |
          echo "ğŸ” Checking file size limits..."
          echo ""

          # Find files larger than 10MB
          LARGE_FILES=$(find . -type f -size +10M ! -path './.git/*' 2>/dev/null || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "::error::Files larger than 10MB detected:"
            echo "$LARGE_FILES"
            echo ""
            echo "ğŸ’¡ Large files are not allowed in this repository."
            echo "   For legitimate large files (documentation PDFs), contact security team."
            exit 1
          fi

          echo "âœ… All files within size limits"
          echo ""

      # ============================================================================
      # CUSTOMER DATA PATTERN DETECTION
      # ============================================================================
      - name: Scan for customer data patterns
        run: |
          echo "ğŸ” Scanning for customer data patterns..."
          echo ""

          EXCLUDE_FILES=(
            ".github/workflows/information-barrier.yml"
            ".github/SECURITY.md"
            "docs/INFORMATION_CLASSIFICATION_GUIDE.md"
            "legal/"
          )

          EXCLUDE_PATTERN=""
          for exclude in "${EXCLUDE_FILES[@]}"; do
            EXCLUDE_PATTERN="$EXCLUDE_PATTERN --exclude=$exclude"
          done

          VIOLATIONS=0

          # Email patterns (excluding @alteragro.com.br and examples)
          echo "Checking for external email addresses..."
          if git grep -E '[a-zA-Z0-9._%+-]+@(?!alteragro\.com\.br|example\.com|test\.com)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' -- . $EXCLUDE_PATTERN 2>/dev/null | grep -v -i 'example\|sample\|placeholder\|demo' > /tmp/emails.txt; then
            if [ -s /tmp/emails.txt ]; then
              echo "::warning::External email addresses detected:"
              head -n 10 /tmp/emails.txt
              echo "   âš ï¸  Verify these are not customer emails (PII)"
            fi
          fi

          # Phone number patterns (Brazilian format)
          echo "Checking for phone numbers..."
          if git grep -E '\+55[0-9]{10,11}|\([0-9]{2}\)[[:space:]]*[0-9]{4,5}-[0-9]{4}' -- . $EXCLUDE_PATTERN 2>/dev/null; then
            echo "::error::Phone numbers detected - Customer PII not allowed!"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          # CPF/CNPJ patterns (Brazilian tax IDs)
          echo "Checking for CPF/CNPJ..."
          if git grep -E '[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}|[0-9]{2}\.[0-9]{3}\.[0-9]{3}/[0-9]{4}-[0-9]{2}' -- . $EXCLUDE_PATTERN 2>/dev/null; then
            echo "::error::CPF/CNPJ patterns detected - Customer PII not allowed!"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          echo ""
          if [ $VIOLATIONS -gt 0 ]; then
            echo "::error::Customer data detected!"
            echo ""
            echo "ğŸ’¡ Customer PII is P3-Trade Secret and must not be in public repo."
            echo "   Remove immediately and verify no data leakage occurred."
            exit 1
          fi

          echo "âœ… Customer data pattern scan complete"
          echo ""

      # ============================================================================
      # ALLOWLIST VERIFICATION (using existing scope guard)
      # ============================================================================
      - name: Verify allowlist compliance
        run: |
          echo "ğŸ” Verifying allowlist compliance..."
          echo ""

          # Run the scope guard if it exists
          if [ -f "infra/github/check_allowlist.py" ]; then
            python infra/github/check_allowlist.py || {
              echo "::error::Allowlist violations detected!"
              echo ""
              echo "ğŸ’¡ Files must be in approved directories:"
              echo "   âœ… lsa/spec/, rag/spec/, docs/, infra/github/, legal/, .github/"
              exit 1
            }
          else
            echo "::warning::check_allowlist.py not found, using basic check"

            # Basic allowlist check
            ALLOWED_PATHS='^(\.github/|lsa/spec/|rag/spec/|docs/|infra/github/|legal/|\.git-hooks/|README\.md|\.gitignore)'

            VIOLATIONS=$(git ls-files | grep -Ev "$ALLOWED_PATHS" || true)
            if [ -n "$VIOLATIONS" ]; then
              echo "::error::Files outside allowlist detected:"
              echo "$VIOLATIONS"
              echo ""
              echo "ğŸ’¡ Only specification and documentation files are allowed."
              echo "   Runtime code belongs in private repositories."
              exit 1
            fi
          fi

          echo "âœ… Allowlist compliance verified"
          echo ""

      # ============================================================================
      # UPLOAD REPORTS AS ARTIFACTS
      # ============================================================================
      - name: Upload security scan reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-reports
          path: |
            trufflehog-report.json
            gitleaks-report.json
            dlp-report.json
            gitleaks-output.log
          retention-days: 90
          if-no-files-found: ignore

      # ============================================================================
      # FINAL STATUS
      # ============================================================================
      - name: Security scan summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… INFORMATION BARRIER: ALL CHECKS PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Security Checks Completed:"
          echo "  âœ… TruffleHog: No secrets detected"
          echo "  âœ… GitLeaks: No secrets detected"
          echo "  âœ… Custom DLP: No violations"
          echo "  âœ… Forbidden terms: Clean"
          echo "  âœ… Code files: Compliant"
          echo "  âœ… Prompt patterns: No production prompts"
          echo "  âœ… Model weights: None found"
          echo "  âœ… File sizes: Within limits"
          echo "  âœ… Customer data: Protected"
          echo "  âœ… Allowlist: Verified"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Repository is clear for commit/merge."
          echo ""
          echo "ğŸ”’ Trade secrets protected"
          echo "ğŸ“‹ Specifications compliant"
          echo "âœ… Ready for public release"
          echo ""
