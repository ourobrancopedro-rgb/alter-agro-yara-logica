name: Path Allow-List (Spec-Only)
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  allowlist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Enforce spec-only paths
        run: |
          # Allowed top-level paths for spec-only repository
          ALLOWED_PATHS='^(\.github/|docs/|policy/|governance/|lsa/|rag/|ccb/|kpi/|hashes/|manifests/|legal/|tools/|scripts/|tests/|infra/|NOTICE$|LICENSE$|README\.md$|SECURITY\.md$|CONTRIBUTING\.md$|RESPONSE_PLAYBOOKS\.md$|\.pre-commit-config\.yaml$|\.gitleaks\.toml$|\.gitleaksignore$|\.trufflehog\.yaml$|\.gitignore$|pyproject\.toml$)'
          ALLOWED_EXT='(\.md|\.txt|\.yaml|\.yml|\.json|\.py|\.sh|\.toml)$'

          # Determine changed files (works for push and PR)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }} --depth=1
            files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            files=$(git diff --name-only HEAD~1)
          fi

          echo "$files" | awk 'NF' > changed.txt || true

          # Block disallowed paths
          bad_paths=$(grep -Ev "${ALLOWED_PATHS}" changed.txt || true)
          if [ -n "$bad_paths" ]; then
            echo "❌ Disallowed paths in spec-only repository:"
            echo "$bad_paths"
            exit 1
          fi

          # Extra extension guard
          bad_ext=$(grep -E '\.' changed.txt | grep -Ev "${ALLOWED_EXT}" || true)
          if [ -n "$bad_ext" ]; then
            echo "❌ Disallowed file extensions:"
            echo "$bad_ext"
            exit 1
          fi

      - name: Block binaries & model artifacts
        run: |
          # Forbidden extensions (binaries, models, archives)
          disallowed='(\.ipynb$|\.so$|\.dll$|\.dylib$|\.bin$|\.onnx$|\.pt$|\.pth$|\.ckpt$|\.pkl$|\.tar(\.gz)?$|\.zip$|\.7z$|\.rar$|\.csv$|\.parquet$|id_rsa|id_ed25519|\.env(\.|$)|\.pem$)'

          # Allowed locations for .py files (excluding forbidden locations)
          FORBIDDEN_PY=$(git ls-files | grep '\.py$' | \
            grep -v '^infra/github/' | \
            grep -v '^\.github/' | \
            grep -v '^lsa/spec/examples/' | \
            grep -v '^tools/' | \
            grep -v '^scripts/' | \
            grep -v '^tests/' || true)

          if [ -n "$FORBIDDEN_PY" ]; then
            echo "❌ Python files in disallowed locations:"
            echo "$FORBIDDEN_PY"
            exit 1
          fi

          # Check for other disallowed types
          if git ls-files | egrep -i "${disallowed}"; then
            echo "❌ Binaries/artifacts are not allowed in this repository."
            exit 1
          fi
