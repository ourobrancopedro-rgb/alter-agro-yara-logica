name: Repository Leak Detection & Fork Monitoring

# Purpose: Continuous monitoring for unauthorized repository copies and leaks
# - Detects new public forks
# - Monitors for unauthorized copies on GitHub, GitLab, BitBucket
# - Searches for leaked code on paste sites and code sharing platforms
# - Monitors web for brand name + source code keywords
# - Alerts security team of potential IP leaks

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

  workflow_dispatch:  # Allow manual triggering
    inputs:
      deep_scan:
        description: 'Perform deep scan (slower, more comprehensive)'
        required: false
        type: boolean
        default: false
      search_keywords:
        description: 'Additional keywords to search (comma-separated)'
        required: false
        type: string
        default: ''

  push:
    branches:
      - main
    paths:
      - '.github/workflows/leak-detection-monitoring.yml'
      - 'infra/github/monitor_forks.py'
      - 'infra/github/detect_leaks.py'

permissions:
  contents: read
  issues: write  # For creating alert issues

jobs:
  # ============================================================================
  # JOB 1: GitHub Fork Monitoring
  # ============================================================================
  fork-monitoring:
    name: Monitor GitHub Forks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests PyGithub python-dateutil

      - name: Check for new forks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
        run: |
          python infra/github/monitor_forks.py \
            --repo "$REPOSITORY" \
            --token "$GITHUB_TOKEN" \
            --create-issue-on-alert

      - name: Upload fork monitoring report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fork-monitoring-report
          path: |
            fork_monitoring_report.json
            fork_monitoring_report.md
          retention-days: 90

  # ============================================================================
  # JOB 2: External Leak Detection
  # ============================================================================
  leak-detection:
    name: External Leak Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 python-dateutil

      - name: Scan for leaked code
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          DEEP_SCAN: ${{ github.event.inputs.deep_scan || 'false' }}
          EXTRA_KEYWORDS: ${{ github.event.inputs.search_keywords || '' }}
        run: |
          python infra/github/detect_leaks.py \
            --repo "$REPOSITORY" \
            --token "$GITHUB_TOKEN" \
            --brand "Alter Agro" \
            --architecture "YARA LÃ³gica" \
            --keywords "LSA,PICC,RAG Policy,Contradiction Coverage" \
            --extra-keywords "$EXTRA_KEYWORDS" \
            --deep-scan "$DEEP_SCAN" \
            --create-issue-on-alert

      - name: Upload leak detection report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: leak-detection-report
          path: |
            leak_detection_report.json
            leak_detection_report.md
          retention-days: 90

  # ============================================================================
  # JOB 3: GitHub Code Search Monitoring
  # ============================================================================
  code-search-monitoring:
    name: GitHub Code Search
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Search for leaked code signatures
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for unique code signatures from this repository
          # (excluding our own repository)

          echo "ðŸ” Searching GitHub for potential code leaks..."
          echo ""

          # Unique identifiers from our codebase
          SIGNATURES=(
            "LSA/PICC faith premise >= 0.80"
            "contradiction coverage >= 0.90"
            "infra/github/hash_ledger.json"
            "YARA LÃ³gica Public Specifications"
            "calculate_contradiction_coverage"
            "validate_lsa_schema"
          )

          FOUND_LEAKS=0

          for sig in "${SIGNATURES[@]}"; do
            echo "Searching for: $sig"

            # Use GitHub Code Search API
            response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/search/code?q=$(echo "$sig" | jq -sRr @uri)+NOT+repo:${{ github.repository }}&per_page=10")

            count=$(echo "$response" | jq -r '.total_count // 0')

            if [ "$count" -gt 0 ]; then
              echo "âš ï¸  WARNING: Found $count potential matches"
              FOUND_LEAKS=$((FOUND_LEAKS + count))

              # Log details
              echo "$response" | jq -r '.items[] | "  - \(.repository.full_name): \(.html_url)"'
            else
              echo "âœ… No unauthorized copies found"
            fi

            echo ""

            # Rate limiting (GitHub allows 10 requests per minute for code search)
            sleep 7
          done

          # Save results
          echo "FOUND_LEAKS=$FOUND_LEAKS" >> $GITHUB_ENV

          if [ "$FOUND_LEAKS" -gt 0 ]; then
            echo "::warning::Found $FOUND_LEAKS potential code leaks on GitHub"
          fi

      - name: Create alert issue if leaks found
        if: env.FOUND_LEAKS > 0
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Potential Code Leak Detected - ${process.env.FOUND_LEAKS} matches found`;
            const body = `## Security Alert: Potential Code Leak

            **Detection Time:** ${new Date().toISOString()}
            **Matches Found:** ${process.env.FOUND_LEAKS}
            **Scan Type:** GitHub Code Search

            ### Summary

            Automated monitoring has detected potential unauthorized copies of YARA LÃ³gica code on GitHub.

            ### Next Steps

            1. **Review the workflow run logs** for specific repositories and URLs
            2. **Verify if matches are legitimate** (authorized forks, citations, etc.)
            3. **For unauthorized copies:**
               - Document the infringement
               - Contact repository owner for takedown
               - File DMCA takedown notice if necessary
               - Escalate to legal@alteragro.com.br

            ### Resources

            - [GitHub DMCA Takedown Policy](https://docs.github.com/en/site-policy/content-removal-policies/dmca-takedown-policy)
            - [Legal Team Contact](mailto:legal@alteragro.com.br)
            - [Security Policy](../.github/SECURITY.md)

            ### Workflow Run

            [View detailed scan results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---

            **Auto-generated by Leak Detection Monitoring**
            **Repository:** ${{ github.repository }}
            **Run ID:** ${{ github.run_id }}
            `;

            // Check if similar issue already exists (within last 7 days)
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,leak-detection',
              state: 'open',
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            });

            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'leak-detection', 'urgent']
              });
            } else {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### New Detection - ${new Date().toISOString()}\n\n${body}`
              });
            }

  # ============================================================================
  # JOB 4: Repository Settings Monitor
  # ============================================================================
  settings-monitor:
    name: Monitor Repository Settings
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check repository visibility
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking repository settings..."

          # Get repository details
          repo_info=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}")

          # Check visibility
          visibility=$(echo "$repo_info" | jq -r '.private')
          fork_count=$(echo "$repo_info" | jq -r '.forks_count')

          echo "Repository visibility: $([ "$visibility" = "true" ] && echo "PRIVATE" || echo "PUBLIC")"
          echo "Fork count: $fork_count"

          # Verify expected state (should be public for specs repo)
          if [ "$visibility" = "false" ]; then
            echo "âœ… Repository is public as expected"
          else
            echo "âš ï¸  Repository is private"
          fi

          # Check if forking is enabled
          allow_forking=$(echo "$repo_info" | jq -r '.allow_forking')
          echo "Forking allowed: $allow_forking"

          # Save fork count for comparison
          echo "$fork_count" > .fork_count_baseline

      - name: Check for fork count changes
        run: |
          # Compare with previous baseline (if available from cache)
          # This would be enhanced with actual cache/storage mechanism
          echo "Fork count monitoring baseline saved"

  # ============================================================================
  # JOB 5: Security Summary
  # ============================================================================
  security-summary:
    name: Generate Security Summary
    runs-on: ubuntu-latest
    needs: [fork-monitoring, leak-detection, code-search-monitoring, settings-monitor]
    if: always()

    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# ðŸ›¡ï¸ Leak Detection & Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Monitoring Jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fork Monitoring | ${{ needs.fork-monitoring.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| External Leak Detection | ${{ needs.leak-detection.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Code Search | ${{ needs.code-search-monitoring.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Settings Monitor | ${{ needs.settings-monitor.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Reports Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "reports/" ]; then
            find reports/ -type f -name "*.md" -exec echo "- {}" \; >> $GITHUB_STEP_SUMMARY
          else
            echo "No reports available" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Next Scan:** In 6 hours (automatic)" >> $GITHUB_STEP_SUMMARY
          echo "**Manual Trigger:** Use workflow_dispatch for immediate scan" >> $GITHUB_STEP_SUMMARY
