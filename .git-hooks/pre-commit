#!/usr/bin/env bash

# ============================================================================
# PRE-COMMIT HOOK - YARA Lรณgica Security Guard
# ============================================================================
# Purpose: Client-side protection before commits reach the repository
# Prevents accidental commits of:
# - Secrets and credentials
# - Code files in spec-only repository
# - Files outside allowlist
# - Large files (>10MB)
# - Customer data and PII
#
# Installation: Run .github/scripts/install-hooks.sh
# ============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
MAX_FILE_SIZE_MB=10
STRICT_MODE="${YARA_STRICT_MODE:-0}"

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}๐ก๏ธ  YARA Lรณgica Pre-Commit Security Check${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}โ๏ธ  No staged files to check${NC}"
    exit 0
fi

echo -e "${BLUE}๐ Staged files:${NC}"
echo "$STAGED_FILES" | sed 's/^/   /'
echo ""

ERRORS=0
WARNINGS=0

# ============================================================================
# CHECK 1: Forbidden Terms (Secrets)
# ============================================================================
echo -e "${BLUE}๐ [1/8] Checking for secrets and forbidden terms...${NC}"

FORBIDDEN_PATTERNS=(
    'api_key'
    'api-key'
    'apikey'
    'secret[_-]?key'
    'password'
    'passwd'
    'bearer'
    'credentials'
    'aws_access_key'
    'aws_secret'
    'private_key'
    'AKIA[0-9A-Z]{16}'
    '-----BEGIN.*PRIVATE KEY-----'
)

SECRET_FOUND=0
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if grep -i -n -E "$pattern" "$file" > /dev/null 2>&1; then
                if [ $SECRET_FOUND -eq 0 ]; then
                    echo -e "${RED}   โ Potential secrets detected:${NC}"
                    SECRET_FOUND=1
                fi
                echo -e "${RED}      $file: $pattern${NC}"
                ERRORS=$((ERRORS + 1))
            fi
        done
    fi
done

if [ $SECRET_FOUND -eq 0 ]; then
    echo -e "${GREEN}   โ No secrets detected${NC}"
fi
echo ""

# ============================================================================
# CHECK 2: Allowlist Compliance
# ============================================================================
echo -e "${BLUE}๐ [2/8] Verifying allowlist compliance...${NC}"

ALLOWED_PATHS='^(\.github/|lsa/spec/|rag/spec/|docs/|infra/github/|legal/|README\.md|\.gitignore|\.git-hooks/)'

ALLOWLIST_VIOLATIONS=0
for file in $STAGED_FILES; do
    if ! echo "$file" | grep -E "$ALLOWED_PATHS" > /dev/null; then
        if [ $ALLOWLIST_VIOLATIONS -eq 0 ]; then
            echo -e "${RED}   โ Files outside allowlist:${NC}"
            ALLOWLIST_VIOLATIONS=1
        fi
        echo -e "${RED}      $file${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

if [ $ALLOWLIST_VIOLATIONS -eq 0 ]; then
    echo -e "${GREEN}   โ All files within allowlist${NC}"
fi
echo ""

# ============================================================================
# CHECK 3: Code Files (outside infra/github)
# ============================================================================
echo -e "${BLUE}๐ [3/8] Checking for unauthorized code files...${NC}"

CODE_EXTENSIONS='\.py$|\.js$|\.ts$|\.tsx$|\.jsx$|\.go$|\.java$|\.rb$|\.php$|\.rs$'
CODE_VIOLATIONS=0

for file in $STAGED_FILES; do
    if echo "$file" | grep -E "$CODE_EXTENSIONS" > /dev/null; then
        # Allow in infra/github/ and .github/
        if ! echo "$file" | grep -E '^(infra/github/|\.github/)' > /dev/null; then
            if [ $CODE_VIOLATIONS -eq 0 ]; then
                echo -e "${YELLOW}   โ๏ธ  Code files outside infra/github/:${NC}"
                CODE_VIOLATIONS=1
            fi
            echo -e "${YELLOW}      $file${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
done

if [ $CODE_VIOLATIONS -eq 0 ]; then
    echo -e "${GREEN}   โ No unauthorized code files${NC}"
fi
echo ""

# ============================================================================
# CHECK 4: File Size Limits
# ============================================================================
echo -e "${BLUE}๐ [4/8] Checking file sizes...${NC}"

SIZE_VIOLATIONS=0
MAX_SIZE_BYTES=$((MAX_FILE_SIZE_MB * 1024 * 1024))

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
        if [ "$FILE_SIZE" -gt "$MAX_SIZE_BYTES" ]; then
            if [ $SIZE_VIOLATIONS -eq 0 ]; then
                echo -e "${RED}   โ Files exceeding ${MAX_FILE_SIZE_MB}MB limit:${NC}"
                SIZE_VIOLATIONS=1
            fi
            SIZE_MB=$((FILE_SIZE / 1024 / 1024))
            echo -e "${RED}      $file (${SIZE_MB}MB)${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

if [ $SIZE_VIOLATIONS -eq 0 ]; then
    echo -e "${GREEN}   โ All files within size limits${NC}"
fi
echo ""

# ============================================================================
# CHECK 5: Binary and Model Files
# ============================================================================
echo -e "${BLUE}๐ [5/8] Checking for binary/model files...${NC}"

BINARY_EXTENSIONS='\.bin$|\.safetensors$|\.ckpt$|\.pth$|\.pkl$|\.h5$|\.pb$|\.onnx$'
BINARY_VIOLATIONS=0

for file in $STAGED_FILES; do
    if echo "$file" | grep -E "$BINARY_EXTENSIONS" > /dev/null; then
        if [ $BINARY_VIOLATIONS -eq 0 ]; then
            echo -e "${RED}   โ Binary/model files detected:${NC}"
            BINARY_VIOLATIONS=1
        fi
        echo -e "${RED}      $file${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

if [ $BINARY_VIOLATIONS -eq 0 ]; then
    echo -e "${GREEN}   โ No binary/model files${NC}"
fi
echo ""

# ============================================================================
# CHECK 6: Customer Data Patterns
# ============================================================================
echo -e "${BLUE}๐ [6/8] Scanning for customer data patterns...${NC}"

PII_FOUND=0
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Check for external emails (not @alteragro.com.br)
        if grep -E '[a-zA-Z0-9._%+-]+@(?!alteragro\.com\.br)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' "$file" > /dev/null 2>&1; then
            if [ $PII_FOUND -eq 0 ]; then
                echo -e "${YELLOW}   โ๏ธ  External email addresses found:${NC}"
                PII_FOUND=1
            fi
            echo -e "${YELLOW}      $file${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi

        # Check for phone numbers
        if grep -E '\+55[0-9]{10,11}|\\([0-9]{2}\\) [0-9]{4,5}-[0-9]{4}' "$file" > /dev/null 2>&1; then
            echo -e "${RED}   โ Phone numbers detected in: $file${NC}"
            ERRORS=$((ERRORS + 1))
        fi

        # Check for CPF/CNPJ
        if grep -E '[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}|[0-9]{2}\.[0-9]{3}\.[0-9]{3}/[0-9]{4}-[0-9]{2}' "$file" > /dev/null 2>&1; then
            echo -e "${RED}   โ CPF/CNPJ patterns detected in: $file${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

if [ $PII_FOUND -eq 0 ]; then
    echo -e "${GREEN}   โ No customer data patterns detected${NC}"
fi
echo ""

# ============================================================================
# CHECK 7: GPG Signature Requirement
# ============================================================================
echo -e "${BLUE}๐ [7/8] Verifying GPG signing configuration...${NC}"

GPG_SIGNING=$(git config --get commit.gpgsign || echo "false")
if [ "$GPG_SIGNING" != "true" ]; then
    echo -e "${YELLOW}   โ๏ธ  GPG signing is not enabled${NC}"
    echo -e "${YELLOW}      Run: git config commit.gpgsign true${NC}"
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "${GREEN}   โ GPG signing enabled${NC}"
fi
echo ""

# ============================================================================
# CHECK 8: Run Custom DLP Scanner (if available)
# ============================================================================
echo -e "${BLUE}๐ [8/8] Running custom DLP scanner...${NC}"

if [ -f "infra/github/scan_secrets.py" ]; then
    if python3 infra/github/scan_secrets.py --strict --staged > /dev/null 2>&1; then
        echo -e "${GREEN}   โ Custom DLP scanner passed${NC}"
    else
        echo -e "${RED}   โ Custom DLP scanner detected violations${NC}"
        echo -e "${RED}      Run: python infra/github/scan_secrets.py --staged${NC}"
        ERRORS=$((ERRORS + 1))
    fi
else
    echo -e "${YELLOW}   โ๏ธ  Custom DLP scanner not found (infra/github/scan_secrets.py)${NC}"
    WARNINGS=$((WARNINGS + 1))
fi
echo ""

# ============================================================================
# FINAL SUMMARY
# ============================================================================
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}โ COMMIT BLOCKED: $ERRORS error(s) detected${NC}"
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${YELLOW}โ๏ธ  Also found $WARNINGS warning(s)${NC}"
    fi
    echo ""
    echo -e "${YELLOW}๐ To fix:${NC}"
    echo -e "${YELLOW}   1. Review the errors above${NC}"
    echo -e "${YELLOW}   2. Remove sensitive content from staged files${NC}"
    echo -e "${YELLOW}   3. Run: git status${NC}"
    echo -e "${YELLOW}   4. Unstage problematic files: git reset HEAD <file>${NC}"
    echo ""
    echo -e "${YELLOW}๐ก To bypass (DANGEROUS - only for emergencies):${NC}"
    echo -e "${YELLOW}   git commit --no-verify${NC}"
    echo ""
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}โ๏ธ  $WARNINGS warning(s) detected${NC}"
    echo ""

    if [ "$STRICT_MODE" = "1" ]; then
        echo -e "${RED}โ Strict mode enabled - warnings treated as errors${NC}"
        exit 1
    fi

    # Prompt user for confirmation
    echo -e "${YELLOW}Do you want to proceed with the commit? (y/N)${NC}"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo -e "${RED}โ Commit cancelled by user${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}โ All security checks passed!${NC}"
echo -e "${GREEN}   $ERRORS errors, $WARNINGS warnings${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

exit 0
